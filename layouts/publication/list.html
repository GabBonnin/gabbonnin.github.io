{{ define "main" }}
<h1>Publications</h1>

<!-- Filters -->
<div style="margin-bottom: 1rem;">
  <label>Year:</label>
  <select id="yearFilter" onchange="applyFilters()">
    <option value="">All</option>
  </select>

  <label>Type:</label>
  <select id="typeFilter" onchange="applyFilters()">
    <option value="">All</option>
  </select>
</div>

<div id="publications"></div>

<!-- Modal -->
<div id="citeModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span onclick="closeCiteModal()" class="close">&times;</span>
    <h4>Citation</h4>
    <pre id="bibtexText"></pre>
    <button onclick="copyBibtex()">Copy</button>
    <a id="downloadBibtex" download="cite.bib"><button>Download</button></a>
  </div>
</div>

<script>
let publications = [];

fetch('/publication/publications.json')
  .then(response => response.json())
  .then(data => {
    // Sort by year descending
    publications = data.sort((a, b) => parseInt(b.year) - parseInt(a.year));
    populateFilters();
    renderPublications(publications);
  });

function populateFilters() {
  const years = [...new Set(publications.map(p => p.year))].sort((a,b) => b - a);
  const types = [...new Set(publications.map(p => p.publication_type_name))].sort();

  const yearSelect = document.getElementById('yearFilter');
  years.forEach(y => {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  });

  const typeSelect = document.getElementById('typeFilter');
  types.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    typeSelect.appendChild(opt);
  });
}

function applyFilters() {
  const year = document.getElementById('yearFilter').value;
  const type = document.getElementById('typeFilter').value;

  const filtered = publications.filter(p =>
    (year === "" || p.year === year) &&
    (type === "" || p.publication_type_name === type)
  );

  renderPublications(filtered);
}

function renderPublications(list) {
  const container = document.getElementById('publications');
  container.innerHTML = '';

  list.forEach(pub => {
    const div = document.createElement('div');
    div.classList.add('publication-item');
    div.innerHTML = `
      <h3>${pub.title}</h3>
      <p><em>${pub.journal}</em> (${pub.year})</p>
      <p>${pub.authors.join(', ')}</p>
      <p>${pub.publication_type_name}</p>
      <button onclick="showCiteModal('${pub.cite_path}', '${pub.bibtex}')">Cite</button>
    `;
    container.appendChild(div);
  });
}

function showCiteModal(path, bibtex) {
  document.getElementById('bibtexText').innerText = bibtex.replace(/\\n/g, '\n');
  document.getElementById('downloadBibtex').href = path;
  document.getElementById('citeModal').style.display = 'block';
}
function closeCiteModal() {
  document.getElementById('citeModal').style.display = 'none';
}
function copyBibtex() {
  const text = document.getElementById('bibtexText').innerText;
  navigator.clipboard.writeText(text).then(() => {
    alert('BibTeX copied to clipboard!');
  });
}
</script>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: white;
  padding: 20px;
  max-width: 600px;
  border-radius: 6px;
}
.close {
  float: right;
  cursor: pointer;
  font-size: 24px;
}
.publication-item {
  margin-bottom: 20px;
}
</style>
{{ end }}